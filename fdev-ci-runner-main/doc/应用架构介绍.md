# ğŸ§± é¡¹ç›®æ¶æ„
ç³»ç»Ÿæ¶æ„å›¾

fdev-ciæµæ°´çº¿ç”±å¹¶è¡Œæˆ–ä¸²è¡Œçš„jobç»„æˆï¼Œæ¯ä¸ªjobç”±å¤šä¸ªpluginç»„æˆã€‚

## ç»„æˆ


ç”±ci-runnerå’Œci-runner-helperç»„æˆï¼Œ ci-runnerä»fdevåç«¯æ¥å£è·å–jobï¼Œæ ¹æ®é…ç½®çš„executorå¼•æ“ï¼Œæ‰§è¡Œpluginsã€‚

ci-runnerè´Ÿè´£å‘åç«¯è·å–jobï¼Œæ‰§è¡Œæµç¨‹ï¼Œä¸Šä¼ æ—¥å¿—ï¼Œå¯åŠ¨æ„å»ºpodã€‚

æ„å»ºpodä¸­åŒ…å«helper Containerã€build Containerã€å¤šä¸ªservice Container

helper Containerä½¿ç”¨ci-runner-helperçš„é•œåƒè´Ÿè´£ä¸‹è½½æºç ã€æ’ä»¶ã€ä¸Šä¼ åŠä¸‹è½½æ„å»ºç‰©ã€‚

build Containerè´Ÿè´£æ‰§è¡Œpluginã€‚

## ä¸šåŠ¡æµç¨‹

### æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ci-runnerâ”‚                                         â”‚fdev-backendâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              æ¯3sè·å–ä¸€æ¬¡job
(1)RequestJobâ—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€jobs/request
     â”‚                                                            
     â”‚                                                          
(2)executor Prepare                                                        
(2.1)k8såˆå§‹åŒ– pod                                                                  
     â”‚                                                            
(3)executor Run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€æ‰§è¡Œè¿‡ç¨‹ä¸­å®æ—¶ä¸Šä¼ æ—¥å¿—â”€â”€â”€â”€â–ºjobs/trace                 
     â”‚                                   
     â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   
     â”‚        â”‚  ci-runner-helper â”‚                                   
     â”‚        â”‚     Container     â”‚                                             
     â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              (3.1)git clone              
     â”‚                 â”‚
     â”‚                 â”‚â—„â”€â”€gitlabä¸‹è½½æºç                 
     â”‚                 â”‚                      
     â”‚        â”Œ â–º (3.2)æ ¹æ®Plugins Countå¾ªç¯æ‰§è¡Œä»¥ä¸‹æ­¥éª¤  
     â”‚        |        â”‚
     â”‚        |        â”‚â—„â”€â”€â”€â”€â”€è¯·æ±‚è·å–è¿™æ¬¡æ’ä»¶ä¿¡æ¯â”€â”€â”€â”€â”€â”€â”€plugins/request
     â”‚        |        â”‚
     â”‚        |        â”‚
     â”‚        |   (3.2.1)plugin-before                  
     â”‚        |        â”‚  
     â”‚        |        â”‚â—„â”€â”€minioä¸‹è½½æ’ä»¶    
     â”‚        |        â”‚           
     â”‚        |        â”‚â—„â”€â”€â”€â”€â”€â”€ä¸‹è½½æ’ä»¶inputâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€plugins/input
     â”‚        |        â”‚
     â”‚        |   (3.2.2)artifact-download 
     â”‚        |        â”‚
     â”‚        |        â”‚        
     â”‚        |        â”‚â—„â”€â”€â”€â”€â”€â”€è·å–è¦ä¸‹è½½å“ªäº›æ„å»ºç‰©â”€â”€â”€â”€â”€â”€artifacts/request
     â”‚        |        â”‚  
     â”‚        |        â”‚â—„â”€â”€minioä¸‹è½½æ„å»ºç‰©
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   build Container è¿è¡Œæ’ä»¶ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     |        |        â”‚
     |        |   (3.2.3)artifact-upload
     |        |        â”‚            
     |        |        â”‚â—„â”€â”€â”€â”€â”€â”€â”€ä¸Šä¼ æ–‡ä»¶è·¯å¾„â”€â”€â”€â”€â”€â”€â”€â”€artifacts/webhook
     |        |        â”‚       
     |        |        â”‚  
     |        |        â”‚â”€â”€â–ºminioä¸Šä¼ æ„å»ºç‰©
     |        |        â”‚
     |        |        â”‚            
     |        |   (3.2.4)plugin-afterâ”€â”€â”€â”€â”€â”€ä¸Šä¼ æ‰§è¡Œè¾“å‡ºâ”€â”€â”€â”€â”€â”€â”€â–ºplugins/output
     |        |        â”‚
     |        â”” -------â”˜    
     â”‚
     â”‚
     â”‚               
(4)executor Wait/SendError
     â”‚                   æ‰§è¡ŒæˆåŠŸ/å¤±è´¥
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºjobs/webhook
     â”‚            
(5)executor Cleanup    åˆ é™¤pod
     â”‚  ä¸Šä¼ æ—¥å¿—
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºminio
    ç»“æŸ
```

### ä»¥executor_kubernetesä¸ºä¾‹

ä¸ºäº†ä¾¿äºåˆæ¥è§¦è€…ç†Ÿæ‚‰æµç¨‹ï¼Œæ¢³ç†æµç¨‹å›¾å¯¹åº”çš„æ–‡ä»¶å’Œæ–¹æ³•å¦‚ä¸‹ï¼š

- (1) RequestJob:  pkg/ci-runner/app/network/fdevCiApi.goæ–‡ä»¶çš„RequestJob()æ–¹æ³•
- (2)executor Prepare: pkg/ci-runner/app/executors/kubernetes/executor_kubernetes.goæ–‡ä»¶çš„Prepare()æ–¹æ³•
  - (2.1)k8såˆå§‹åŒ– pod: pkg/ci-runner/app/executors/kubernetes/executor_kubernetes.goæ–‡ä»¶çš„setupBuildPod()æ–¹æ³•
- (3)executor Run: pkg/ci-runner/app/executors/kubernetes/executor_kubernetes.goæ–‡ä»¶çš„Run()æ–¹æ³•
  - (3.1)git clone: pkg/ci-runner-helper/cmd/git/git.goæ–‡ä»¶çš„NewCmdGit()æ–¹æ³•
  - (3.2)æ ¹æ®Plugins Countå¾ªç¯æ‰§è¡Œä»¥ä¸‹æ­¥éª¤: pkg/ci-runner/app/network/fdevCiApi.goæ–‡ä»¶çš„RequestPlugin()æ–¹æ³•
    - (3.2.1)plugin-before: pkg/ci-runner-helper/cmd/pluginbefore/plugin-before.goæ–‡ä»¶çš„NewCmdPluginBefore()æ–¹æ³•
    - (3.2.2)artifact-download: pkg/ci-runner-helper/cmd/artifactdownload/artifact-download.goæ–‡ä»¶çš„NewCmdArtifactDownload()æ–¹æ³•
    - (3.2.3)artifact-upload: pkg/ci-runner-helper/cmd/artifactupload/artifact-upload.goæ–‡ä»¶çš„NewCmdArtifactUpload()æ–¹æ³•
    - (3.2.4)plugin-after: pkg/ci-runner-helper/cmd/git/git.goæ–‡ä»¶çš„NewCmdPluginAfter()æ–¹æ³•
- (4)executor Wait/SendError: pkg/ci-runner/app/executors/kubernetes/executor_kubernetes.goæ–‡ä»¶çš„Wait()æ–¹æ³•
- (5)executor Cleanup : pkg/ci-runner/app/executors/kubernetes/executor_kubernetes.goæ–‡ä»¶çš„Cleanup()æ–¹æ³•



| æµç¨‹                                   | æ–‡ä»¶                                                         | æ–¹æ³•                     |
| -------------------------------------- | ------------------------------------------------------------ | ------------------------ |
| (1)RequestJob                          | pkg/ci-runner/app/network/fdevCiApi.go                       | RequestJob()             |
| (2)executor Prepare                    | pkg/ci-runner/app/executors/kubernetes/executor_kubernetes.go | Prepare()                |
| (2.1)k8såˆå§‹åŒ– pod                     | pkg/ci-runner/app/executors/kubernetes/executor_kubernetes.go | setupBuildPod()          |
| (3)executor Run                        | pkg/ci-runner/app/executors/kubernetes/executor_kubernetes.go | Run()                    |
| (3.1)git clone                         | pkg/ci-runner-helper/cmd/git/git.go                          | NewCmdGit()              |
| (3.2)æ ¹æ®Plugins Countå¾ªç¯æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ | pkg/ci-runner/app/network/fdevCiApi.go                       | RequestPlugin()          |
| (3.2.1)plugin-before                   | pkg/ci-runner-helper/cmd/pluginbefore/plugin-before.go       | NewCmdPluginBefore()     |
| (3.2.2)artifact-download               | pkg/ci-runner-helper/cmd/artifactdownload/artifact-download.go | NewCmdArtifactDownload() |
| (3.2.3)artifact-upload                 | pkg/ci-runner-helper/cmd/artifactupload/artifact-upload.go   | NewCmdArtifactUpload()   |
| (3.2.4)plugin-after                    | pkg/ci-runner-helper/cmd/git/git.go                          | NewCmdPluginAfter()      |
| (4)executor Wait/SendError             | pkg/ci-runner/app/executors/kubernetes/executor_kubernetes.go | Wait()                   |
| (5)executor Cleanup                    | pkg/ci-runner/app/executors/kubernetes/executor_kubernetes.go | Cleanup()                |

## é¡¹ç›®ç›®å½•ç»“æ„æ ‘

```
fdev-ci-runner-main
â”œâ”€ cmd
â”‚  â”œâ”€ ci-runner
â”‚  â””â”€ ci-runner-helper
â”œâ”€ config
â”œâ”€ dockerfiles
â”‚  â”œâ”€ ci-runner
â”‚  â””â”€ ci-runner-helper
â”œâ”€ pkg
â”‚  â”œâ”€ ci-runner
â”‚  â”‚  â”œâ”€ app
â”‚  â”‚  â”‚  â”œâ”€ common
â”‚  â”‚  â”‚  â”œâ”€ executors
â”‚  â”‚  â”‚  â”‚  â”œâ”€ kubernetes
â”‚  â”‚  â”‚  â”‚  â””â”€ local
â”‚  â”‚  â”‚  â”œâ”€ network
â”‚  â”‚  â”‚  â””â”€ run
â”‚  â”‚  â””â”€ cmd
â”‚  â”‚     â”œâ”€ run
â”‚  â”‚     â””â”€ version
â”‚  â”œâ”€ ci-runner-helper
â”‚  â”‚  â”œâ”€ artifactdownload
â”‚  â”‚  â”œâ”€ artifactupload
â”‚  â”‚  â”œâ”€ git
â”‚  â”‚  â”œâ”€ pluginafter
â”‚  â”‚  â”œâ”€ pluginbefore
â”‚  â”‚  â””â”€ version
â”‚  â”œâ”€ prometheus
â”‚  â”œâ”€ utlis
â”‚  â”‚  â”œâ”€ ansi
â”‚  â”‚  â”œâ”€ command
â”‚  â”‚  â”œâ”€ file
â”‚  â”‚  â”œâ”€ http
â”‚  â”‚  â”œâ”€ k8s
â”‚  â”‚  â”œâ”€ log
â”‚  â”‚  â”œâ”€ minio
â”‚  â”‚  â”œâ”€ trace
â”‚  â”‚  â”œâ”€ url
â”‚  â”‚  â””â”€ zip
â”‚  â””â”€ version
â”œâ”€ .gitignore
â”œâ”€ .golangci.yml
â”œâ”€ go.mod
â”œâ”€ go.sum
â”œâ”€ LICENSE
â”œâ”€ Makefile
â””â”€ README.md
```
